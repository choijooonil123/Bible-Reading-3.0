@@ -1,408 +1,408 @@
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ë§ì”€ì½ê¸°APP</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10183a">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <link rel="stylesheet" href="styles.css"/>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <!-- ì•± ì½”ë“œ -->
  <script src="books.js" defer></script>
  <script src="firebaseConfig.js" defer></script>
  <script src="app.js" defer></script>

  <!-- (ì„ íƒ) ìµœì†Œ ìŠ¤íƒ€ì¼: í”„ë¡œì íŠ¸ì— ì´ë¯¸ ìœ ì‚¬ í´ë˜ìŠ¤ê°€ ìˆìœ¼ë©´ ìƒëµ ê°€ëŠ¥ -->
  <style>
    ._card{background:#1a2250;border:1px solid #2a3155;border-radius:12px;padding:12px;margin:10px 0}
    ._row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    ._input{flex:1;min-width:260px;padding:8px 10px;border-radius:8px;border:1px solid #46507b;background:#0e1538;color:#eaf0ff}
    ._btn{padding:8px 12px;border-radius:8px;border:1px solid #46507b;background:#18204d;color:#fff;cursor:pointer}
    ._btn:hover{background:#1b2556}
    #rangeVerses p{margin:6px 0;padding:4px 6px;border-radius:6px}
    #rangeVerses p strong{color:#6ea8fe}
    hr._sep{border:0;height:1px;background:#2a3155;margin:10px 0}
  </style>
</head>
<body>

  <!-- A. ë¡œê·¸ì¸ í™”ë©´ -->
  <section id="screen-login" class="screen show">
    <div class="hero">
      <div class="glow"></div>
      <div class="login-card">
        <div class="login-head">
          <div class="logo-hero">ğŸ“–</div>
          <h1>ë§ì”€ì½ê¸°APP</h1>
          <p class="muted">ì´ë©”ì¼ Â· ë¹„ë°€ë²ˆí˜¸ Â· (ì„ íƒ) í‘œì‹œì´ë¦„ Â· (ì„ íƒ) ë‹‰ë„¤ì„</p>
        </div>

        <div class="login-body">
          <label class="form-label" for="email">ì´ë©”ì¼</label>
          <input id="email" class="input" type="email" placeholder="name@example.com" autocomplete="email"/>

          <label class="form-label mt12" for="password">ë¹„ë°€ë²ˆí˜¸</label>
          <input id="password" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"/>

          <label class="form-label mt12" for="displayName">í‘œì‹œì´ë¦„ (ì„ íƒ, ë‚´ í™”ë©´ìš©)</label>
          <input id="displayName" class="input" type="text" placeholder="ì˜ˆ: í™ê¸¸ë™" autocomplete="name"/>

          <label class="form-label mt12" for="nickname">ë‹‰ë„¤ì„ (ì„ íƒ, ìˆœìœ„ ê³µê°œìš©)</label>
          <input id="nickname" class="input" type="text" placeholder="ì˜ˆ: ë‹¤ìœ—"/>

          <div class="row mt16" style="gap:8px; width:100%">
            <button id="btnLogin" class="btn primary fill">ë¡œê·¸ì¸</button>
            <button id="btnSignup" class="btn fill">íšŒì›ê°€ì…</button>
          </div>
        </div>

        <div class="login-foot muted">
          <small>í‘œì‹œì´ë¦„ì€ ë‚´ í™”ë©´ì—ë§Œ, ë‹‰ë„¤ì„ì€ ìˆœìœ„í‘œì— ê³µê°œë©ë‹ˆë‹¤.</small>
        </div>
      </div>
    </div>
  </section>

  <!-- B. ë³¸í™”ë©´ (ë¡œê·¸ì¸ í›„) -->
  <section id="screen-app" class="screen">
    <header class="appbar">
      <div class="brand"><span class="logo">ğŸ“–</span><strong>ë§ì”€ì½ê¸°</strong></div>
      <div class="actions">
        <button id="btnOpenMatrix" class="btn small">í˜„í™©í‘œ</button>
      </div>
      <div id="signedIn" class="userbox hidden">
        <img id="userPhoto" class="avatar" alt="avatar"/>
        <span id="userName"></span>
        <button id="btnSignOut" class="btn small danger">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <main class="container">
      <!-- ì„ íƒ ì„¹ì…˜ -->
      <section class="card">
        <details open>
          <summary>ì„±ê²½(66ê¶Œ) ì„ íƒ</summary>
          <div class="field-row">
            <label for="bookSelect" class="form-label">ì„±ê²½</label>
            <select id="bookSelect" class="select"></select>
          </div>
        </details>

        <details class="mt12">
          <summary>ì¥ ì„ íƒ</summary>
          <div id="chapterGrid" class="grid"></div>
        </details>

        <details class="mt12">
          <summary>ì ˆ ì„ íƒ</summary>
          <div id="verseGrid" class="grid small"></div>
        </details>
      </section>

      <!-- ë¦¬ë” ì„¹ì…˜ -->
      <section class="card">
        <div class="reader-head">
          <div>
            <div id="locLabel" class="loc"></div>
            <div id="verseCount" class="muted"></div>
          </div>
        </div>
        <div id="verseContainer" class="verse-container">
          <div id="verseText" class="verse-text">ì„±ê²½/ì¥/ì ˆì„ ì„ íƒí•˜ì„¸ìš”.</div>
          <div id="listenHint" class="muted sm">ìŒì„± ì¸ì‹ìœ¼ë¡œ ì½ìœ¼ë©´ ê¸€ìê°€ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
        </div>

        <!-- ë§ˆì´í¬ ê°ì§€ ë ˆë²¨ -->
        <div style="margin:8px 0;">
          <div id="micBar" style="height:6px; background:#43d17a; width:0%; transition:width 0.1s"></div>
          <small id="micDb" class="muted">-âˆ dB</small>
        </div>

        <!-- ğŸ‘‡ ìŒì„±ë§¤ì¹­ ì—„ê²©ë„ í‘œì‹œ/ì„ íƒ (UIë§Œ ì¶”ê°€) -->
        <div id="strictControls" class="muted sm" style="margin:6px 0 0 0;">
          <span>ë§¤ì¹­:</span>
          <label style="margin-left:6px;"><input type="radio" name="matchStrict" value="ì—„ê²©"> ì—„ê²©</label>
          <label style="margin-left:6px;"><input type="radio" name="matchStrict" value="ë³´í†µ" checked> ë³´í†µ</label>
          <label style="margin-left:6px;"><input type="radio" name="matchStrict" value="ê´€ëŒ€"> ê´€ëŒ€</label>
        </div>

        <!-- ë²„íŠ¼ë“¤: ê³ ì •í˜•(ì˜¤ë¥¸ìª½) âŸ¨ / ğŸ™ï¸ / âŸ©  -->
        <div class="fab-row" style="
          position:fixed; right:12px; top:50%; transform:translateY(-50%);
          display:flex; flex-direction:column; gap:12px; align-items:center; z-index:1000;">
          <button id="btnPrevVerse" class="fab" aria-label="ì´ì „ ì ˆ">âŸ¨</button>
          <button id="btnToggleMic" class="fab primary" aria-label="ë§ˆì´í¬ í† ê¸€">ğŸ™ï¸</button>
          <button id="btnNextVerse" class="fab" aria-label="ë‹¤ìŒ ì ˆ">âŸ©</button>
        </div>

        <!-- â€˜í•´ë‹¹ì ˆì½ìŒâ€™ ë²„íŠ¼: ì˜¤ë¥¸ìª½ ì •ë ¬ & ì´ˆë¡ìƒ‰ -->
        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button id="btnMarkRead" style="background:#43d17a; color:#fff; padding:6px 12px; border-radius:6px;">
            í•´ë‹¹ì ˆì½ìŒ
          </button>
        </div>

        <!-- í†µê³„ì¤„ -->
        <div class="row between stats">
          <strong id="myStats">â€”</strong>
          <label class="muted"><input type="checkbox" id="autoAdvance" checked/> ì ˆ ì™„ë£Œ ì‹œ ìë™ ì´ë™</label>
        </div>
      </section>

      <!-- âœ… [ì¶”ê°€] êµ¬ê°„ ì…ë ¥ + ë³¸ë¬¸ í‘œì‹œ + ë“£ê¸°(TTS) (ìˆœìœ„ ì¹´ë“œ ìœ„ì— ìœ„ì¹˜) -->
      <section id="rangeReader" class="_card">
        <div class="_row">
          <input id="rangeInput" class="_input"
                 placeholder="ì˜ˆ) ì°½ì„¸ê¸° 1:1~3 / ì°½ì„¸ê¸° 1:31~2:3 / ì°½ì„¸ê¸° 1~3 / ì°½ì„¸ê¸° 1ì¥"/>
          <button id="rangeLoadBtn" class="_btn">ë³¸ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="_row" style="margin-top:8px">
          <button id="rangePlay"  class="_btn">â–¶ ì¬ìƒ</button>
          <button id="rangePause" class="_btn">â¸ ì¼ì‹œì •ì§€/ì¬ê°œ</button>
          <button id="rangeStop"  class="_btn">â–  ì •ì§€</button>
          <label style="margin-left:12px">ì†ë„
            <select id="rangeRate">
              <option value="0.9">0.9</option>
              <option value="1" selected>1.0</option>
              <option value="1.1">1.1</option>
              <option value="1.2">1.2</option>
            </select>
          </label>
          <label style="margin-left:12px">ìŒì„±
            <select id="rangeVoice"></select>
          </label>
        </div>
        <hr class="_sep"/>
        <div id="rangeVerses"></div>
      </section>

      <!-- ìˆœìœ„ -->
      <section class="card">
        <h3>ğŸ“ˆ ì½ê¸° ìˆœìœ„</h3>
        <ol id="leaderList" class="leaders"></ol>
        <p class="muted sm">â€» ë‹‰ë„¤ì„ì´ ì—†ëŠ” ì‚¬ìš©ìëŠ” ì´ë©”ì¼ ì•ë¶€ë¶„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
      </section>
    </main>

    <!-- í˜„í™©í‘œ ëª¨ë‹¬ -->
    <div id="matrixModal" class="modal hidden">
      <div class="modal-body full">
        <div class="row between">
          <h3>ì½ê¸° í˜„í™©í‘œ</h3>
          <button id="btnCloseMatrix" class="btn small" type="button">ë‹«ê¸°</button>
        </div>
        <div id="matrixWrap" class="matrix-wrap"></div>
        <div class="muted smallprint">* ì´ˆë¡=ì™„ë… ì¥, íšŒìƒ‰=ë¯¸ì™„ë£Œ (ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥)</div>
      </div>
    </div>
  </section>

  <!-- ===== [ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸] êµ¬ê°„ íŒŒì‹± + ë³¸ë¬¸ ìˆ˜ì§‘ + TTS ===== -->
  <script>
  (() => {
    let voices = [];
    let queue = []; // {ref, text}[]
    let idx = 0;
    let bibleCache = null;

    // bible.json ë¡œë“œ
    async function getBible() {
      if (bibleCache) return bibleCache;
      bibleCache = await fetch('bible.json', { cache: 'force-cache' }).then(r => r.json());
      return bibleCache;
    }

    // ì…ë ¥ íŒŒì‹±
    /*
      - "ì„±ê²½ ì°½ì„¸ê¸° 1:1~3"
      - "ì°½ì„¸ê¸° 1:31~2:3"
      - "ì°½ì„¸ê¸° 1~3"
      - "ì°½ì„¸ê¸° 1ì¥ 1ì ˆ~3ì ˆ" / "ì°½ì„¸ê¸° 1ì¥~3ì¥" / "ì°½ì„¸ê¸° 1ì¥"
      - "ì°½ì„¸ê¸° 1"
    */
    function parseRange(input) {
      let s = (input || '').trim();
      s = s.replace(/^ì„±ê²½\s*/,'');
      s = s.replace(/[ï¼š]/g, ':');
      s = s.replace(/\s+/g, ' ');
      s = s.replace(/ì¥/g, ':');
      s = s.replace(/ì ˆ/g, '');

      const m = /^([^\d]+)\s+(.+)$/.exec(s);
      if (!m) return null;
      const book = m[1].trim();
      const rest = m[2].trim();

      // 1) ë™ì¥ ì ˆë²”ìœ„ 1:1~3
      let mm = /^(\d+)\s*:\s*(\d+)\s*[~\-]\s*(\d+)$/.exec(rest);
      if (mm) return { book, c1:+mm[1], v1:+mm[2], c2:+mm[1], v2:+mm[3] };

      // 2) ì¥è·¨ ì ˆë²”ìœ„ 1:31~2:3
      mm = /^(\d+)\s*:\s*(\d+)\s*[~\-]\s*(\d+)\s*:\s*(\d+)$/.exec(rest);
      if (mm) return { book, c1:+mm[1], v1:+mm[2], c2:+mm[3], v2:+mm[4] };

      // 3) ì¥ ë²”ìœ„ 1~3
      mm = /^(\d+)\s*[~\-]\s*(\d+)$/.exec(rest);
      if (mm) return { book, c1:+mm[1], v1:1, c2:+mm[2], v2:Infinity };

      // +) í•œ ì¥ 1
      mm = /^(\d+)$/.exec(rest);
      if (mm) return { book, c1:+mm[1], v1:1, c2:+mm[1], v2:Infinity };

      return null;
    }

    // ì±… í‚¤ í•´ì„(í•œê¸€/ì˜ë¬¸/ê³µë°±ì°¨ì´ì— ìœ ì—°)
    function resolveBookKey(bibleObj, raw) {
      if (bibleObj[raw]) return raw;
      const norm = s => (s||'').replace(/\s+/g,'').toLowerCase();
      const hit = Object.keys(bibleObj).find(k => norm(k) === norm(raw));
      // books.jsì— KO ë§¤í•‘ì´ ìˆë‹¤ë©´ ì°¸ê³  (ì„ íƒ)
      if (!hit && window.BOOKS) {
        const byKo = (window.BOOKS.find(b => norm(b.ko) === norm(raw)));
        if (byKo && bibleObj[byKo.ko]) return byKo.ko;
      }
      return hit || raw;
    }

    // ë³¸ë¬¸ ìˆ˜ì§‘
    function collectVerses(bookObj, refs, title) {
      const out = [];
      const { c1, v1=1, c2, v2=Infinity } = refs;
      for (let c=c1; c<=c2; c++) {
        const ch = bookObj?.[String(c)];
        if (!ch) continue;
        const startV = (c===c1) ? v1 : 1;
        const endV   = (c===c2) ? v2 : Infinity;
        const nums = Object.keys(ch).map(n=>+n).filter(n=>n>=startV && n<=endV).sort((a,b)=>a-b);
        nums.forEach(vn => {
          const text = String(ch[String(vn)] || '').trim();
          if (text) out.push({ ref: `${title} ${c}:${vn}`, text });
        });
      }
      return out;
    }

    // ë Œë”
    function render(list) {
      const box = document.getElementById('rangeVerses');
      if (!box) return;
      if (!list.length) { box.innerHTML = '<p>ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
      box.innerHTML = list.map((v,i)=>`<p data-ridx="${i}"><strong>${v.ref}</strong> ${v.text}</p>`).join('');
      highlight();
    }
    function highlight() {
      const box = document.getElementById('rangeVerses');
      if (!box) return;
      [...box.querySelectorAll('p')].forEach(p => p.style.background='transparent');
      const cur = box.querySelector(`p[data-ridx="${idx}"]`);
      if (cur) {
        cur.style.background = 'rgba(255,255,0,0.18)';
        cur.scrollIntoView({ behavior:'smooth', block:'center' });
      }
    }

    // ë¡œë“œ í•¸ë“¤ëŸ¬
    async function onLoadRange() {
      const val = (document.getElementById('rangeInput')?.value || '').trim();
      if (!val) { alert('êµ¬ê°„ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ì°½ì„¸ê¸° 1:1~3 / ì°½ì„¸ê¸° 1:31~2:3 / ì°½ì„¸ê¸° 1~3 / ì°½ì„¸ê¸° 1ì¥'); return; }
      const refs = parseRange(val);
      if (!refs) { alert('ì…ë ¥ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.'); return; }

      const bible = await getBible();
      const bookKey = resolveBookKey(bible, refs.book);
      const bookObj = bible[bookKey];
      if (!bookObj) { alert(`"${refs.book}"(ì„)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`); return; }

      const verses = collectVerses(bookObj, refs, refs.book);
      if (!verses.length) { alert('í•´ë‹¹ êµ¬ê°„ì˜ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      queue = verses;
      idx = 0;
      render(verses);
    }

    // TTS
    function ttsPlayAll() {
      if (!queue.length) { alert('ë¨¼ì € ë³¸ë¬¸ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
      if ('speechSynthesis' in window === false) { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
      if (speechSynthesis.paused) { speechSynthesis.resume(); return; }
      if (speechSynthesis.speaking) return;
      idx = 0;
      speakNext();
    }
    function speakNext() {
      if (idx >= queue.length) { speechSynthesis.cancel(); return; }
      const rate  = parseFloat(document.getElementById('rangeRate')?.value || '1') || 1;
      const vName = document.getElementById('rangeVoice')?.value;
      const cur   = queue[idx];

      const u = new SpeechSynthesisUtterance(`${cur.ref}. ${cur.text}`);
      const u = new SpeechSynthesisUtterance(`cur.text`);
      u.rate = rate;

      const v = voices.find(x => x.name === vName) ||
                voices.find(x => /ko-KR/i.test(x.lang)) ||
                voices[0];
      if (v) u.voice = v;

      u.onstart = () => highlight();
      u.onend   = () => { if (!speechSynthesis.paused) { idx++; speakNext(); } };
      u.onerror = () => { idx++; speakNext(); };

      speechSynthesis.speak(u);
    }
    function ttsTogglePause() {
      if (!('speechSynthesis' in window) || !speechSynthesis.speaking) return;
      if (speechSynthesis.paused) speechSynthesis.resume();
      else speechSynthesis.pause();
    }
    function ttsStopAll() {
      if (!('speechSynthesis' in window)) return;
      speechSynthesis.cancel();
      idx = 0;
      highlight();
    }

    // ì´ë²¤íŠ¸ ì—°ê²° & ìŒì„± ëª©ë¡ ì±„ìš°ê¸°
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('rangeLoadBtn')?.addEventListener('click', onLoadRange);
      document.getElementById('rangePlay')?.addEventListener('click', ttsPlayAll);
      document.getElementById('rangePause')?.addEventListener('click', ttsTogglePause);
      document.getElementById('rangeStop')?.addEventListener('click', ttsStopAll);

      if ('speechSynthesis' in window) {
        const populate = () => {
          voices = speechSynthesis.getVoices() || [];
          const sel = document.getElementById('rangeVoice');
          if (!sel) return;
          const ko = voices.filter(v => /ko-KR/i.test(v.lang));
          const rest = voices.filter(v => !/ko-KR/i.test(v.lang));
          sel.innerHTML = '';
          [...ko, ...rest].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            sel.appendChild(opt);
          });
          if (ko.length) sel.value = ko[0].name;
        };
        populate();
        speechSynthesis.onvoiceschanged = populate;
      }
    });
  })();
  </script>
  <!-- ===== /ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸ ===== -->

</body>
</html>
